<!doctype html>
<html lang="en">

<head>
	<title>DCS | Home</title>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

	<link href="https://fonts.googleapis.com/css?family=Poppins:300,400,500,600,700,800,900" rel="stylesheet">

	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="css/style.css">
	<style>
		.content {
			flex: 1;
			padding: 20px;
		}

		.timeForm{
			width: 75vw;
			background-color: #0056b3;
		}
		input[type="time"],
		button {
			margin: 10px 0;
			padding: 10px;
			max-width: 100%;
			width: 100%;
			box-sizing: border-box;
		}

		#currentDate {
			text-align: center;
			margin-bottom: 20px;
		}

		.popup {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			backdrop-filter: blur(5px);
			display: flex;
			align-items: center;
			justify-content: center;
			z-index: 1000;
		}

		.popup-content {
			display: none;
			background: white;
			padding: 20px;
			width: 250px;
			border-radius: 5px;
			text-align: center;
		}

		.popup-content p {
			margin: 0 0 20px;
		}

		.popup-content button {
			padding: 10px 20px;
			border: none;
			background: #007BFF;
			color: white;
			border-radius: 5px;
			cursor: pointer;
		}

		.popup-content button:hover {
			background: #0056b3;
		}

		@media only screen and (max-width: 768px) {
			.container {
				flex-direction: column;
			}



			.content {
				width: 100%;
			}

			input[type="time"],
			button {
				margin: 10px 0;
				padding: 10px;
				width: 90vw;
				box-sizing: border-box;
			}
		}
	</style>
</head>

<body>
	
	<div id="popup" class="popup">
		<div class="popup-content" id = 'popup-content'>
			<p id = popup-text></p>
			<button onclick="redirectToLogin()">OK</button>
		</div>
	</div>
	<div class="wrapper d-flex align-items-stretch">
		<nav id="sidebar" class="active">
			<div class="custom-menu">
				<button type="button" id="sidebarCollapse" class="btn btn-primary">
					<i class="fa fa-bars"></i>
					<span class="sr-only">Toggle Menu</span>
				</button>
			</div>
			<div class="p-4">
				<h1><a href="index.html" class="logo">DCS</a></h1>
				<ul class="list-unstyled components mb-5">
					<li class="active">
						<a href="homepage.html?"><span class="fa fa-home mr-3"></span> Home</a>
					</li>
					<li>
						<a href="#"><span class="fa fa-user mr-3"></span> About</a>
					</li>
					<li>
						<a href="records.html?"><span class="fa fa-briefcase mr-3"></span> Records</a>
					</li>
					<li>
						<a href="schedule.html?"><span class="fa fa-sticky-note mr-3"></span> Schedule</a>
					</li>
					<li>
						<a href="#"><span class="fa fa-paper-plane mr-3"></span> Contact Us</a>
					</li>
					<li>
						<a href="#" id="logout"><span class="fa fa-paper-plane mr-3"></span> Logout</a>
					</li>
				</ul>

				<!--<div class="mb-5">
					<h3 class="h6 mb-3">Subscribe for newsletter</h3>
					<form action="#" class="subscribe-form">
						<div class="form-group d-flex">
							<div class="icon"><span class="icon-paper-plane"></span></div>
							<input type="text" class="form-control" placeholder="Enter Email Address">
						</div>
					</form>
				</div>-->

				<div class="footer">
					<p><!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
						Copyright &copy;
						<script>document.write(new Date().getFullYear());</script> All rights reserved | Jerwin F. Gubat
						<i class="icon-heart" aria-hidden="true"></i> <a href="https://colorlib.com"
							target="_blank">Colorlib.com</a>
						<!-- Link back to Colorlib can't be removed. Template is licensed under CC BY 3.0. -->
					</p>
				</div>

			</div>
		</nav>
		<div id="content" class="p-4 p-md-5 pt-5" style="width: 50%; margin-left: 3vw;">
			<form id="timeForm">
				<h2>Time Tracker</h2>
				<div id="currentDate"></div>
				<div id="weekDay"></div>
				<label for="timeIn">Time In:</label>
				<input type="time" id="timeIn" name="timeIn" required>
				<button type="button" id="submitTimeIn">Submit Time In</button>
				<br>
				<label for="timeOut">Time Out:</label>
				<input type="time" id="timeOut" name="timeOut" required>
				<button type="button" id="submitTimeOut">Submit Time Out</button>
			</form>
			<div id="timeDisplay"></div>
		</div>
		<div id="content" class="p-4 p-md-5 pt-5" style="width: 50%; margin-left: 3vw;">
			<form id="timeForm">
				<h2>Overall Revenue</h2>
				<div id="currentDate"></div>
				<div id="weekDay"></div>
				<label for="timeIn">Time In:</label>
				<input type="time" id="timeIn" name="timeIn" required>
				<button type="button" id="submitTimeIn">Submit Time In</button>
				<br>
				<label for="timeOut">Time Out:</label>
				<input type="time" id="timeOut" name="timeOut" required>
				<button type="button" id="submitTimeOut">Submit Time Out</button>
			</form>
			<div id="timeDisplay"></div>
		</div>
	</div>
	<script>

		function redirectToLogin() {
			window.location.href = 'index.html';
		}

	</script>
	<script type="module">
		import { initializeApp } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-app.js";
		import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-analytics.js";
		import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-auth.js";
		import { getDatabase, ref, onValue, push, get, set } from "https://www.gstatic.com/firebasejs/10.4.0/firebase-database.js";

		const firebaseConfig = {
			apiKey: "AIzaSyBtsvTdPydPIdn1GuGpj0qd0oYk2gR4Fzk",
			authDomain: "timemanager-b24cc.firebaseapp.com",
			databaseURL: "https://timemanager-b24cc-default-rtdb.firebaseio.com",
			projectId: "timemanager-b24cc",
			storageBucket: "timemanager-b24cc.appspot.com",
			messagingSenderId: "134877240078",
			appId: "1:134877240078:web:7d0eae6b605a8c1470155f",
			measurementId: "G-HKYCRTSC73"
		};
		//yung firebase config na set is from firebase, ginagamit to para magkaroon ng connecttion ang system and ang database
		firebase.initializeApp(firebaseConfig);
		const app = initializeApp(firebaseConfig);
		const auth = getAuth();
		console.log(auth);

		//bypass counter
		const isAuthenticated = localStorage.getItem('authToken');
		console.log(isAuthenticated);

		if (isAuthenticated == 'false') {
			document.getElementById('popup-text').innerText = "You need to login first";
			document.getElementById('popup').style.display = 'flex';
			document.getElementById('popup-content').style.display = 'block';
		} else if (isAuthenticated == 'true') {
			document.getElementById('popup').style.display = 'none';
		}
		document.getElementById("submitTimeIn").addEventListener("click", function () {
			submitTime('timeIn');
		});

		document.getElementById("submitTimeOut").addEventListener("click", function () {
			submitTime('timeOut');
		});

		var currentDateElement = document.getElementById('currentDate');
		var currentWeekDay = document.getElementById('weekDay');
		var optionsWeekDay = { weekday: 'long' };
		var options = { year: 'numeric', month: '2-digit', day: '2-digit' };
		var currentDate = new Date().toLocaleDateString('en-US', options);
		var currentDay = new Date().toLocaleDateString('en-US', optionsWeekDay);
		currentDateElement.textContent = 'Current Date: ' + currentDate + ', ' + currentDay;

		function submitTime(timeType) {
			var timeValue = document.getElementById(timeType).value;
			var currentDate = new Date();
			var dateKey = formatDateKey(currentDate);
			var dayOfWeek = getDayOfWeek();

			if (timeValue.trim() === "") {
				alert("Please enter a valid time.");
				return;
			}

			var database = firebase.database();

			var scheduleRef = database.ref('schedule');
			scheduleRef.once('value', function (snapshot) {
				var scheduleData = snapshot.val();
				var contactHoursData = scheduleData[dayOfWeek];

				if (!contactHoursData || !contactHoursData.timeIn) {
					alert("Schedule data not available for the current day.");
					return;
				}

				var scheduledTimeIn = contactHoursData.timeIn;
				var scheduledTimeOut = contactHoursData.timeOut;
				var scheduledTimeInDate = new Date(currentDate.toDateString() + ' ' + scheduledTimeIn);
				var scheduledTimeOutDate = new Date(currentDate.toDateString() + ' ' + scheduledTimeOut);
				var timeInDate = new Date(currentDate.toDateString() + ' ' + timeValue);

				var timeDifferenceInMinutes = Math.floor((timeInDate - scheduledTimeInDate) / (1000 * 60));

				var lateMinutes = Math.max(0, timeDifferenceInMinutes);

				var minutesContactHours = (contactHoursData.minutesContactHours || 0);
				var totalMinutesRendered = minutesContactHours;

				if (timeType === 'timeOut' && timeInDate >= scheduledTimeOutDate) {

					var timeLogsRef = database.ref('timeLogs/' + dateKey);
					timeLogsRef.once('value', function (snapshot) {
						var timeLogsData = snapshot.val();
						var minutesLate = timeLogsData ? timeLogsData.minutesLate || 0 : 0;
						totalMinutesRendered = Math.max(0, minutesContactHours - minutesLate);

						console.log("Total rendered minutes:", totalMinutesRendered);

						timeLogsData['remainingMinutes'] = totalMinutesRendered;
						timeLogsRef.set(timeLogsData);
					});
				} else {
					console.log("Time difference in minutes:", timeDifferenceInMinutes);
				}

				var newLogRef = database.ref('timeLogs/' + dateKey);
				newLogRef.once('value', function (snapshot) {
					var data = snapshot.val() || {};

					if (timeType === 'timeIn') {
						data[timeType] = timeValue;
						data['minutesLate'] = timeDifferenceInMinutes;
					} else if (timeType === 'timeOut') {

						data['timeOut'] = timeValue;
						data['minutesLate'] = data['minutesLate'] || 0;
					}
					data['dayOfWeek'] = dayOfWeek;
					data['date'] = formatDateKey(currentDate);

					newLogRef.set(data);
					document.getElementById("timeDisplay").innerHTML = "Day of the Week: " + dayOfWeek + "<br>" +
						timeType.charAt(0).toUpperCase() + timeType.slice(1) + ": " + timeValue + "<br>Time logged successfully!";
				});

			});
		}



		function formatDateKey(date) {
			var month = (date.getMonth() + 1).toString().padStart(2, '0');
			var day = date.getDate().toString().padStart(2, '0');
			var year = date.getFullYear();
			return `${month}-${day}-${year}`;
		}



		function getDayOfWeek() {
			var daysOfWeek = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
			var today = new Date();
			return daysOfWeek[today.getDay()];
		}
		document.getElementById("logout").addEventListener("click", function () {
			event.preventDefault();
			signOut(auth).then(() => {
				console.log('Sign-out successful.');
				document.getElementById('popup').style.display = 'flex';
				document.getElementById('popup-content').style.display = 'block';
				document.getElementById('popup-text').innerText = "Signout Successful";
				localStorage.setItem('authToken', 'false');
				
			}).catch((error) => {
				console.log('An error happened.');
			});
		});
	</script>


	<script src="js/jquery.min.js"></script>
	<script src="js/popper.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/main.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/firebase/7.14.1-0/firebase.js"></script>
</body>

</html>